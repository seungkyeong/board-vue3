<template>
  <!--Profile Ïª¥Ìè¨ÎÑåÌä∏-->
  <UserProfile />

  <div class="container">
    <div class="detail-user" v-if="editBoardToggle">
      <el-avatar
        class="profile-img"
        :size="40"
        :src="require('@/assets/profile.png')"
      />
      <div class="detail-user-idDate">
        <span class="comment-userId" style="font-size: 17px">{{
          form.userId
        }}</span>
        <span class="comment-createDate">{{ form.createDate }}</span>
      </div>
    </div>

    <el-form
      :model="form"
      label-width="auto"
      style="width: 100%; padding-top: 20px"
    >
      <el-form-item label="Ï†úÎ™©">
        <el-input v-model="form.title" :disabled="editBoardToggle" />
      </el-form-item>
      <el-form-item label="ÎÇ¥Ïö©">
        <el-input
          v-model="form.content"
          type="textarea"
          :rows="9"
          resize="none"
          :disabled="editBoardToggle"
        />
      </el-form-item>
      <el-form-item label="Ïù¥ÎØ∏ÏßÄ">
        <div
          class="image-container"
          v-if="form.imgPath.length > 0 && editBoardToggle"
        >
          <el-image v-for="url in form.imgPath" :key="url" :src="url" lazy />
        </div>
        <div
          class="image-no-container"
          v-if="form.imgPath.length === 0 && editBoardToggle"
        >
          Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå
        </div>
        <el-upload
          drag
          :auto-upload="false"
          multiple
          style="width: 100%"
          accept="image/*"
          :on-change="addImgPath"
          :on-remove="removeImgPath"
          :on-preview="imgPreview"
          v-if="!editBoardToggle"
          :file-list="fileList"
        >
          <el-icon class="el-icon--upload"><UploadFilled /></el-icon>
          <div class="el-upload__text">
            Drop file here or <em>click to upload</em>
          </div>
          <template #tip>
            <div class="el-upload__tip">
              jpg/png files with a size less than 500kb
            </div>
          </template>
        </el-upload>
      </el-form-item>
      <el-form-item label="" class="like-wrapper">
        <div class="like-container" v-if="editBoardToggle">
          <el-button type="primary" @click="toggleLikeBtn" :style="buttonStyle"
            >üëç Ï¢ãÏïÑÏöî</el-button
          >
        </div>
      </el-form-item>
    </el-form>

    <div class="button-container">
      <el-button type="primary" @click="modifyBoard">ÏàòÏ†ï</el-button>
      <el-button @click="goBack">Î™©Î°ù</el-button>
    </div>

    <!-- Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
    <el-dialog v-model="dialogVisible" width="50%">
      <img :src="previewImage" alt="ÎØ∏Î¶¨Î≥¥Í∏∞" style="width: 100%" />
    </el-dialog>

    <div class="comment-container" v-if="editBoardToggle">
      <div class="createComment-container">
        <el-input
          v-model="newComment.comment"
          type="textarea"
          :rows="3"
          resize="none"
          placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."
        />
        <el-button type="primary" @click="createComment(null)">Îì±Î°ù</el-button>
      </div>

      <div
        v-for="comment in commentList"
        :key="comment.sysNo"
        class="comment-item"
        style="padding-top: 30px"
      >
        <!-- ÌîÑÎ°úÌïÑ -->
        <div class="comment-item-user">
          <!-- Ï¢åÏ∏° ÌîÑÎ°úÌïÑ -->
          <div class="comment-user-info">
            <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ -->
            <el-avatar
              class="profile-img"
              :size="40"
              :src="require('@/assets/profile.png')"
            />
            <!-- ÏÉùÏÑ±ÏùºÏûê -->
            <div class="comment-item-user-idDate">
              <span class="comment-userId" style="font-size: 17px">{{
                comment.userId
              }}</span>
              <span class="comment-createDate">{{ comment.createDate }}</span>
            </div>
          </div>

          <!-- Ïö∞Ï∏° ÌîÑÎ°úÌïÑ -->
          <!-- ÎçîÎ≥¥Í∏∞ Î©îÎâ¥(‚ãÆ) -->
          <template
            v-if="comment.userSysNo !== null && !comment.editCommentToggle"
          >
            <el-dropdown trigger="click">
              <span class="el-dropdown-link" style="cursor: pointer">
                <el-icon><MoreFilled /></el-icon>
              </span>
              <template v-slot:dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item @click="editComment(comment)"
                    >ÏàòÏ†ïÌïòÍ∏∞</el-dropdown-item
                  >
                  <el-dropdown-item @click="deleteComment(comment)"
                    >ÏÇ≠Ï†úÌïòÍ∏∞</el-dropdown-item
                  >
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </template>
        </div>

        <!-- ÎåìÍ∏Ä ÎÇ¥Ïö© -->
        <div v-if="!comment.editCommentToggle">
          <p class="comment-text">
            <template v-if="comment.userSysNo == null">
              <el-icon style="margin-right: 10px"><WarningFilled /></el-icon>
            </template>
            {{ comment.comment }}
          </p>
        </div>
        <div v-else style="margin-left: 45px; margin-top: 10px">
          <div style="display: flex; gap: 10px; width: 100%">
            <el-input
              v-model="comment.editText"
              type="textarea"
              :rows="3"
              resize="none"
              style="flex: 1"
            />
            <el-button type="primary" @click="createComment(comment)">
              ÏàòÏ†ï
            </el-button>
          </div>
        </div>

        <!-- ÎãµÍ∏Ä Î≤ÑÌäº -->
        <div v-if="!comment.editCommentToggle">
          <el-button
            class="comment-replyList"
            type="primary"
            @click="showReplyList(comment)"
            >ÎãµÍ∏Ä {{ comment.replies.length }}</el-button
          >
        </div>
        <div v-else>
          <el-button
            class="comment-replyList"
            @click="cancleEditComment(comment)"
            style="margin-top: 10px"
          >
            Ï∑®ÏÜå
          </el-button>
        </div>

        <!-- ÎåÄÎåìÍ∏Ä Î¶¨Ïä§Ìä∏ -->
        <div v-if="!comment.editCommentToggle">
          <div v-if="comment.repliesVisible">
            <div
              v-for="reply in comment.replies"
              :key="reply.sysNo"
              class="replies"
              style="padding-top: 10px"
            >
              <!-- ÌîÑÎ°úÌïÑ -->
              <div class="comment-item-user">
                <!-- Ï¢åÏ∏° ÌîÑÎ°úÌïÑ -->
                <div class="comment-user-info">
                  <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ -->
                  <el-avatar
                    class="profile-img"
                    :size="40"
                    :src="require('@/assets/profile.png')"
                  />
                  <!-- ÏÉùÏÑ±ÏùºÏûê -->
                  <div class="comment-item-user-idDate">
                    <span class="comment-userId" style="font-size: 17px">{{
                      reply.userId
                    }}</span>
                    <span class="comment-createDate">{{
                      reply.createDate
                    }}</span>
                  </div>
                </div>

                <!-- Ïö∞Ï∏° ÌîÑÎ°úÌïÑ -->
                <!-- ÎçîÎ≥¥Í∏∞ Î©îÎâ¥(‚ãÆ) -->
                <template
                  v-if="reply.userSysNo !== null && !reply.editCommentToggle"
                >
                  <el-dropdown trigger="click">
                    <span class="el-dropdown-link" style="cursor: pointer">
                      <el-icon><MoreFilled /></el-icon>
                    </span>
                    <template v-slot:dropdown>
                      <el-dropdown-menu>
                        <el-dropdown-item @click="editComment(reply)"
                          >ÏàòÏ†ïÌïòÍ∏∞</el-dropdown-item
                        >
                        <el-dropdown-item @click="deleteComment(reply)"
                          >ÏÇ≠Ï†úÌïòÍ∏∞</el-dropdown-item
                        >
                      </el-dropdown-menu>
                    </template>
                  </el-dropdown>
                </template>
              </div>
              <!-- ÎåìÍ∏Ä ÎÇ¥Ïö© -->
              <div v-if="!reply.editCommentToggle">
                <p class="comment-text">
                  <template v-if="reply.userSysNo == null">
                    <el-icon style="margin-right: 10px"
                      ><WarningFilled
                    /></el-icon> </template
                  >{{ reply.comment }}
                </p>
              </div>
              <div v-else style="margin-left: 45px; margin-top: 10px">
                <div style="display: flex; gap: 10px; width: 100%">
                  <el-input
                    v-model="reply.editText"
                    type="textarea"
                    :rows="3"
                    resize="none"
                    style="flex: 1"
                  />
                  <el-button type="primary" @click="createComment(reply)">
                    ÏàòÏ†ï
                  </el-button>
                </div>
              </div>

              <div v-if="reply.editCommentToggle">
                <el-button
                  class="comment-replyList"
                  @click="cancleEditComment(reply)"
                  style="margin-top: 10px"
                >
                  Ï∑®ÏÜå
                </el-button>
              </div>
            </div>

            <div class="createReply-container">
              <el-input
                v-model="replyInputs[comment.sysNo]"
                type="textarea"
                :rows="3"
                resize="none"
                placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."
              />
              <el-button type="primary" @click="createComment(comment)"
                >Îì±Î°ù</el-button
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import UserProfile from '../components/Profile'
import { reactive, onMounted, ref, computed } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessageBox } from 'element-plus'
import boardAPI from '../api/BoardAPI'
import { useAuthStore } from '../store/auth'
import {
  UploadFilled,
  MoreFilled,
  WarningFilled,
} from '@element-plus/icons-vue'

export default {
  components: {
    UserProfile,
    UploadFilled,
    MoreFilled,
    WarningFilled,
  },
  setup() {
    const router = useRouter()
    const route = useRoute()
    const authStore = useAuthStore()
    const sysNoParam = route.params.sysNo // URL Í≤ΩÎ°úÏóêÏÑú sysNoÎ•º Í∞ÄÏ†∏Ïò¥
    const userId = authStore.getUserId
    const userSysNo = authStore.getSysNo
    const editBoardToggle = ref(true)
    let deletedImages = ref([]) // ÏÇ≠Ï†úÎêú Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ Ï∂îÏ†Å
    let fileData = new FormData()
    const previewImage = ref('')
    const dialogVisible = ref(false)
    let fileList = ref([])
    const commentList = ref([])
    const replyInputs = reactive({})
    const isLiked = ref(false) // Ï¢ãÏïÑÏöî ÏÉÅÌÉú

    //Board Detail Form
    const form = reactive({
      sysNo: '',
      title: '',
      content: '',
      imgPath: [],
      userId: '',
      userSysNo: '',
      createDate: '',
    })

    //ÏÉàÎ°úÏö¥ ÎåìÍ∏Ä
    const newComment = reactive({
      sysNo: '',
      boardSysNo: '', //ÎØ∏Î¶¨ ÏÑ∏ÌåÖÎêòÏñ¥Ïïº Ìï®
      title: '',
      comment: '',
      userId: userId, //ÎØ∏Î¶¨ ÏÑ∏ÌåÖÎêòÏñ¥Ïïº Ìï®
      userSysNo: userSysNo, //ÎØ∏Î¶¨ ÏÑ∏ÌåÖÎêòÏñ¥Ïïº Ìï®
      boardCreater: '',
      boardCreaterSysNo: '',
    })

    //ÏÉàÎ°úÏö¥ ÎãµÍ∏Ä
    const newReply = reactive({
      sysNo: '',
      parSysNo: '',
      boardSysNo: '', //ÎØ∏Î¶¨ ÏÑ∏ÌåÖÎêòÏñ¥Ïïº Ìï®
      title: '',
      comment: '',
      userId: userId, //ÎØ∏Î¶¨ ÏÑ∏ÌåÖÎêòÏñ¥Ïïº Ìï®
      userSysNo: userSysNo, //ÎØ∏Î¶¨ ÏÑ∏ÌåÖÎêòÏñ¥Ïïº Ìï®
      boardCreater: '',
      boardCreaterSysNo: '',
    })

    const getBoardDetail = async () => {
      const response = await boardAPI.getBoardDetail({
        type: 'detail',
        searchList: { sysNo: sysNoParam },
        pageSize: 10,
        pageIndex: 0,
        userId: userId,
        userSysNo: userSysNo,
      })

      if (response.success) {
        //s3ÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
        if (
          response.data[0].imgPath.length > 0 &&
          response.data[0].imgPath[0] != ''
        ) {
          const prefix = 'https://demofille.s3.ap-northeast-2.amazonaws.com/'
          for (let i = 0; i < response.data[0].imgPath.length; i++) {
            form.imgPath.push(prefix + response.data[0].imgPath[i])
          }
          updateFileList()
        }

        //Í≤åÏãúÎ¨º ÏÉÅÏÑ∏ ÏÑ∏ÌåÖ
        //Ïù¥ÎØ∏ÏßÄ ÌååÏùº Ïù¥Î¶Ñ Î∞∞Ïó¥Î°ú Ï†ÄÏû•
        form.sysNo = response.data[0].sysNo
        form.title = response.data[0].title
        form.content = response.data[0].content
        form.userId = response.data[0].userId
        form.userSysNo = response.data[0].userSysNo
        form.createDate = response.data[0].createDate

        //ÏÉàÎ°úÏö¥ ÎåìÍ∏ÄÏùÑ ÏúÑÌïú ÏÑ∏ÌåÖ
        newComment.boardSysNo = response.data[0].sysNo
        newComment.boardCreater = response.data[0].userId
        newComment.boardCreaterSysNo = response.data[0].userSysNo
        newComment.title = response.data[0].title
        newReply.title = response.data[0].title
        newReply.boardSysNo = response.data[0].sysNo
        newReply.boardCreater = response.data[0].userId
        newReply.boardCreaterSysNo = response.data[0].userSysNo

        //ÎåìÍ∏Ä Î¶¨Ïä§Ìä∏ ÏÑ∏ÌåÖ
        commentList.value = response.data[1].map((comment) => ({
          ...comment,
          editCommentToggle: false, // ÏàòÏ†ï Î™®Îìú Ïó¨Î∂Ä
          editText: comment.comment, // ÏàòÏ†ï Ï§ë ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Í∞í
          repliesVisible: false, // Ï¥àÍ∏∞ÏóêÎäî ÎåÄÎåìÍ∏Ä Ïà®ÍπÄ
          replies:
            comment.replies?.map((reply) => ({
              ...reply,
              editCommentToggle: false,
              editText: reply.comment,
            })) || [],
        }))
        if (response.data[0].likeFlag == 'like') {
          isLiked.value = true // ÌååÎûÄ Î≤ÑÌäº (Ï¢ãÏïÑÏöî ÎàÑÎ¶Ñ)
        } else {
          isLiked.value = false // Ìù∞ Î≤ÑÌäº (Ï¢ãÏïÑÏöî Ïïà ÎàÑÎ¶Ñ)
        }
      } else {
        ElMessageBox.alert(response.message, '', {
          confirmButtonText: 'ÌôïÏù∏',
          type: 'error',
        }).catch(() => {})
      }
    }

    //Î°úÎìúÏãú Í≤åÏãúÎ¨º Ï°∞Ìöå
    onMounted(() => {
      getBoardDetail()
    })

    //Ï∑®ÏÜåÎ≤ÑÌäº ÌÅ¥Î¶≠Ïãú Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    const goBack = () => {
      router.go(-1)
    }

    //ÏóÖÎ°úÎìú ÏòÅÏó≠Ïóê ÌååÏùº Ï∂îÍ∞ÄÏãú Ï†úÎ™©ÏùÑ imgPathÏóê ÎÑ£Ïùå
    const addImgPath = (file) => {
      fileData.append('files', file.raw)
    }

    //ÏóÖÎ°úÎìú ÏòÅÏó≠Ïóê ÌååÏùº Ï†úÍ±∞Ïãú Ï†úÎ™©ÏùÑ imgPathÏóêÏÑú Ï†úÍ±∞
    const removeImgPath = (file) => {
      if (file.url) {
        // Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú Ïãú deletedImagesÏóê Ï∂îÍ∞Ä
        deletedImages.value.push(file.url)
        form.imgPath = form.imgPath.filter((img) => img !== file.url)
      } else {
        const newFileData = new FormData()
        for (const [key, value] of fileData.entries()) {
          if (value !== file.raw) {
            newFileData.append(key, value) // Í∏∞Ï°¥ ÌååÏùº Ï§ë ÏÇ≠Ï†ú ÎåÄÏÉÅÏù¥ ÏïÑÎãå ÌååÏùºÎßå Ï∂îÍ∞Ä
          }
        }
        fileData = newFileData // Í∏∞Ï°¥ FormData ÍµêÏ≤¥
      }
    }

    //ÏóÖÎ°úÎìúÌïú ÌååÏùº ÌÅ¥Î¶≠Ïãú ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞
    const imgPreview = (file) => {
      previewImage.value = file.url || URL.createObjectURL(file.raw) // Î°úÏª¨ URL ÏÉùÏÑ±
      dialogVisible.value = true
    }

    const updateFileList = () => {
      const updatedList = form.imgPath.map((url, index) => {
        const fileName = url.split('/')[3] // ÌååÏùº Ïù¥Î¶Ñ Ï∂îÏ∂ú
        const uid = `file-${index}` // Í≥†Ïú† ID ÏÉùÏÑ±
        return {
          name: fileName,
          url, // ÌååÏùº URL
          uid,
        }
      })
      fileList.value = [...updatedList]
    }

    //ÏàòÏ†ïÎ≤ÑÌäº ÌÅ¥Î¶≠Ïãú ÏàòÏ†ï ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    const modifyBoard = async () => {
      if (!editBoardToggle.value) {
        if (!form.title.trim() || !form.content.trim()) {
          ElMessageBox.alert('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!', '', {
            confirmButtonText: 'ÌôïÏù∏',
            type: 'warning',
          }).catch(() => {})
        } else {
          //ÌååÏùº ÏóÖÎ°úÎìú ÏàòÌñâ API Ìò∏Ï∂ú
          if (fileData.has('files')) {
            let fileNames = []
            //S3ÏóêÏÑú PresignedURL Î∞úÍ∏â
            const presignedURLs = await boardAPI.getPresignedURL(fileData)
            //S3Ïóê ÏóÖÎ°úÎìú
            const files = fileData.getAll('files')
            for (let i = 0; i < presignedURLs.length; i++) {
              const file = files[i] // FormDataÏóêÏÑú Ìï¥Îãπ ÌååÏùº Í∞ÄÏ†∏Ïò§Í∏∞
              // S3Ïóê ÌååÏùº ÏóÖÎ°úÎìú
              const response = await boardAPI.uploadFile(presignedURLs[i], file)
              fileNames.push(decodeURIComponent(response.split('/')[3]))
            }
            form.imgPath = [
              ...form.imgPath.map((url) => url.split('/').pop()), // Í∏∞Ï°¥ ÌååÏùºÎ™ÖÎßå Ï∂îÏ∂ú
              ...fileNames, // ÏÉàÎ°ú ÏóÖÎ°úÎìúÎêú ÌååÏùºÎ™Ö Ï∂îÍ∞Ä
            ]
          }
          //s3ÏóêÏÑú ÌååÏùº ÏÇ≠Ï†ú + ÏÑúÎ≤Ñ ÎßåÎì§Ïñ¥Ïïº Ìï®
          if (deletedImages.value.length > 0) {
            const deletePayload = { keys: deletedImages.value }

            await boardAPI.deleteFiles(deletePayload)
          }
          form.imgPath = [
            ...form.imgPath.map((url) => url.split('/').pop()), // Í∏∞Ï°¥ ÌååÏùºÎ™ÖÎßå Ï∂îÏ∂ú
          ]

          //Ï†ÄÏû• ÏàòÌñâ API Ìò∏Ï∂ú
          const response = await boardAPI.createBoard(form)

          if (response.success) {
            ElMessageBox.alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', '', {
              confirmButtonText: 'ÌôïÏù∏',
              type: 'success',
            })
              .then(() => {
                form.imgPath = []
                deletedImages.value = []
                fileList.value = []
                fileData = new FormData()
                getBoardDetail()
                editBoardToggle.value = true
              })
              .catch(() => {})
          } else {
            ElMessageBox.alert(response.message, '', {
              confirmButtonText: 'ÌôïÏù∏',
              type: 'error',
            }).catch(() => {})
          }
        }
      } else {
        //ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûëÏÑ±ÏûêÏù¥Î©¥ ÏàòÏ†ï
        if (form.userId == userId) {
          //ÌÜ†Í∏ÄÌïòÍ∏∞
          updateFileList()
          editBoardToggle.value = false
        } else {
          ElMessageBox.alert('ÏûëÏÑ±ÏûêÏôÄ ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.', '', {
            confirmButtonText: 'ÌôïÏù∏',
            type: 'warning',
          }).catch(() => {})
        }
      }
    }

    //Ï¢ãÏïÑÏöî Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú Redis Ï¢ãÏïÑÏöî Count Ï¶ùÍ∞Ä
    const toggleLikeBtn = async () => {
      if (isLiked.value) {
        //Ï¢ãÏïÑÏöî ÎàÑÎ•∏ ÏÉÅÌô© -> Ï∑®ÏÜåÏù∏ Í≤ΩÏö∞
        isLiked.value = false
        await boardAPI.updateLike({
          action: 'unLike',
          boardSysNo: form.sysNo,
          userId: userId,
          userSysNo: userSysNo,
        })
      } else {
        //Ï¢ãÏïÑÏöî ÏïàÎàÑÎ•∏ ÏÉÅÌô© -> Ï¢ãÏïÑÏöî ÎàÑÎ•∏ Í≤ΩÏö∞
        isLiked.value = true
        await boardAPI.updateLike({
          action: 'like',
          boardSysNo: form.sysNo,
          userId: userId,
          userSysNo: userSysNo,
        })
      }
    }

    //ÎåìÍ∏Ä Îì±Î°ù Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú ÎåìÍ∏Ä Ï†ÄÏû•
    const createComment = async (comment = null) => {
      let response
      //ÎåìÍ∏Ä, ÎåÄÎåìÍ∏Ä ÏàòÏ†ï
      if ((comment != null) & comment.editCommentToggle) {
        newReply.comment = comment.editText
        newReply.sysNo = comment.sysNo
        newReply.parSysNo = comment.parSysNo
        response = await boardAPI.createComment(newReply)
      } else if (comment != null) {
        //ÎåÄÎåìÍ∏Ä Ïã†Í∑ú Îì±Î°ùÏù∏ Í≤ΩÏö∞
        newReply.parSysNo = comment.sysNo
        newReply.boardSysNo = form.sysNo
        newReply.comment = replyInputs[comment.sysNo] || '' // Ìï¥Îãπ ÎåìÍ∏ÄÏùò ÏûÖÎ†•Í∞í ÏÇ¨Ïö©

        response = await boardAPI.createComment(newReply)
      } else {
        //ÎåìÍ∏Ä Ïã†Í∑ú Îì±Î°ùÏù∏ Í≤ΩÏö∞
        response = await boardAPI.createComment(newComment)
      }

      if (response.success) {
        ElMessageBox.alert('ÎåìÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.', '', {
          confirmButtonText: 'ÌôïÏù∏',
          type: 'success',
        })
          .then(() => {
            newComment.comment = ''
            Object.keys(replyInputs).forEach((key) => (replyInputs[key] = '')) // Î™®Îì† ÎåÄÎåìÍ∏Ä ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
            newReply.comment = ''
            getBoardDetail()
          })
          .catch(() => {})
      } else {
        ElMessageBox.alert(response.message, '', {
          confirmButtonText: 'ÌôïÏù∏',
          type: 'error',
        }).catch(() => {})
      }
    }

    const showReplyList = (comment) => {
      comment.repliesVisible = !comment.repliesVisible // ÌÜ†Í∏Ä Í∏∞Îä•
    }

    // Î≤ÑÌäº Ïä§ÌÉÄÏùº (computed)
    const buttonStyle = computed(() => {
      return {
        backgroundColor: isLiked.value ? '#409EFF' : '#ffffff', // Ï¢ãÏïÑÏöîÍ∞Ä ÎàåÎ¶¨Î©¥ ÌååÎûÄÏÉâ, ÏïÑÎãàÎ©¥ Ìù∞ÏÉâ
        color: isLiked.value ? '#ffffff' : 'black', // ÎàåÎ¶∞ ÏÉÅÌÉúÎäî Ìù∞ÏÉâ ÌÖçÏä§Ìä∏, ÏïÑÎãàÎ©¥ ÌååÎûÄÏÉâ ÌÖçÏä§Ìä∏
        borderColor: isLiked.value ? '#409EFF' : '#dcdfe6', // ÎàåÎ¶∞ ÏÉÅÌÉúÎäî ÌååÎûÄÏÉâ ÌÖåÎëêÎ¶¨, ÏïÑÎãàÎ©¥ Í∏∞Î≥∏ ÌÖåÎëêÎ¶¨
      }
    })

    //ÎåìÍ∏Ä ÏàòÏ†ï
    const editComment = async (comment) => {
      if (comment.userId == userId) {
        comment.editCommentToggle = true // ÏÑ†ÌÉùÎêú ÎåìÍ∏ÄÎßå ÏàòÏ†ï Î™®ÎìúÎ°ú
        comment.editText = comment.comment
      } else {
        ElMessageBox.alert('ÏûëÏÑ±ÏûêÏôÄ ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.', '', {
          confirmButtonText: 'ÌôïÏù∏',
          type: 'warning',
        }).catch(() => {})
      }
    }

    //ÎåìÍ∏Ä ÏÇ≠Ï†ú
    const deleteComment = async (comment) => {
      if (comment.userId == userId) {
        try {
          await ElMessageBox.confirm('ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', 'Í≤ΩÍ≥†', {
            confirmButtonText: 'ÏÇ≠Ï†ú',
            cancelButtonText: 'Ï∑®ÏÜå',
            type: 'warning',
          })

          //ÏÇ≠Ï†ú ÎàÑÎ•∏ Í≤ΩÏö∞ÏóêÎßå ÏÇ≠Ï†ú Ïã§Ìñâ
          const response = await boardAPI.deleteComment({
            sysNo: comment.sysNo,
          })

          if (response.success) {
            await ElMessageBox.alert('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', '', {
              confirmButtonText: 'ÌôïÏù∏',
              type: 'success',
            })
              .then(() => {
                getBoardDetail()
              })
              .catch(() => {})
          } else {
            await ElMessageBox.alert(
              response.message || 'ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
              '',
              {
                confirmButtonText: 'ÌôïÏù∏',
                type: 'warning',
              }
            )
          }
        } catch (e) {
          // ÏÇ¨Ïö©ÏûêÍ∞Ä 'Ï∑®ÏÜå' Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÍ±∞ÎÇò confirmÏù¥ rejectÎêú Í≤ΩÏö∞
          console.log('ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÇ≠Ï†úÎ•º Ï∑®ÏÜåÌñàÏäµÎãàÎã§.')
        }
      } else {
        ElMessageBox.alert('ÏûëÏÑ±ÏûêÏôÄ ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.', '', {
          confirmButtonText: 'ÌôïÏù∏',
          type: 'warning',
        }).catch(() => {})
      }
    }

    //ÎåìÍ∏Ä ÏàòÏ†ï Ï∑®ÏÜå
    const cancleEditComment = async (comment) => {
      comment.editCommentToggle = false
      comment.repliesVisible = false
    }

    return {
      goBack,
      form,
      modifyBoard,
      sysNoParam,
      editBoardToggle,
      getBoardDetail,
      addImgPath,
      imgPreview,
      removeImgPath,
      updateFileList,
      fileList,
      previewImage,
      dialogVisible,
      deletedImages,
      toggleLikeBtn,
      newComment,
      createComment,
      commentList,
      showReplyList,
      newReply,
      replyInputs,
      buttonStyle,
      editComment,
      deleteComment,
      cancleEditComment,
    }
  },
}
</script>

<style scoped>
.container {
    padding: 30px 400px 30px 400px;
}
.like-container{
  padding-bottom: 20px;
}
.like-container .el-button{
  border-radius: 50px; /* Î≤ÑÌäºÏùÑ Îë•Í∏ÄÍ≤å ÎßåÎì¶ */
  padding: 10px 20px; /* Ï†ÅÎãπÌïú ÎÇ¥Î∂Ä Ïó¨Î∞± */
  background-color: white;
  color: rgb(149, 148, 148);
  border-color: rgb(149, 148, 148);
}
.button-container {
    display: flex; 
    justify-content: center; 
    margin: 20px;
}
.image-container{ 
  max-height: 450px;  
  overflow-y: auto; 
}
.el-image {
  border: 2px solid #ddd; /* ÌÖåÎëêÎ¶¨ ÏÉâÏÉÅ */
  border-radius: 8px; /* ÌÖåÎëêÎ¶¨ Î™®ÏÑúÎ¶¨Î•º Îë•Í∏ÄÍ≤å */
  padding: 5px; /* Ïù¥ÎØ∏ÏßÄÏôÄ ÌÖåÎëêÎ¶¨ ÏÇ¨Ïù¥ Ïó¨Î∞± */
  max-width: 100%; /* Ïù¥ÎØ∏ÏßÄÍ∞Ä Ïª®ÌÖåÏù¥ÎÑàÎ•º Î≤óÏñ¥ÎÇòÏßÄ ÏïäÎèÑÎ°ù Ï†úÌïú */
  height: auto; /* Ïù¥ÎØ∏ÏßÄ ÎπÑÏú®ÏùÑ Ïú†ÏßÄÌïòÎ©¥ÏÑú ÌÅ¨Í∏∞Î•º Ï°∞Ï†ï */
  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1); /* ÏïΩÍ∞ÑÏùò Í∑∏Î¶ºÏûê Ï∂îÍ∞Ä */
}
::v-deep(.el-form-item__label) {
  font-weight: bold; /* ÎùºÎ≤® ÌÖçÏä§Ìä∏ ÍµµÍ≤å */
}
.comment-container{
  border-top: 2px solid grey;
  padding-top: 20px;
}
.createComment-container{
  display: flex; 
  gap: 10px; /* textareaÏôÄ Î≤ÑÌäº ÏÇ¨Ïù¥ Í∞ÑÍ≤© Ï°∞Ï†à */
}
.comment-item{
  border-bottom: 1px solid #c8c8c8;
}
.comment-item-user, .detail-user{
  display: flex; 
  gap: 10px; /* textareaÏôÄ Î≤ÑÌäº ÏÇ¨Ïù¥ Í∞ÑÍ≤© Ï°∞Ï†à */
  margin-top: 20px;
  justify-content: flex-start; /*space-between; /* Ï¢åÏö∞Î°ú Ï†ïÎ†¨ */
  align-items: center;
}
.comment-item-user-idDate, .detail-user-idDate{
  display: flex;
  flex-direction: column;
  text-align: left;
}
.comment-createDate{
  color: grey;
  font-size: 13px;
  padding-top:5px;
}
.comment-text {
  text-align: left; /* ÏôºÏ™Ω Ï†ïÎ†¨ */
  margin-left: 45px; /* ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ + Ïó¨Î∞± */
}
.comment-replyList{
  display: flex; 
  justify-content: flex-start; /* ÏôºÏ™Ω Ï†ïÎ†¨ */
  align-items: center; /* ÏÑ∏Î°ú Ï§ëÏïô Ï†ïÎ†¨ */
  background-color: white;
  color: grey;
  border-color: grey;
  margin-left: 45px; /* ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÌÅ¨Í∏∞ + Ïó¨Î∞±Í≥º ÎßûÏ∂îÍ∏∞ */
  margin-bottom: 20px;
}
.replies {
  margin-left: 50px; /* Î£®Ìä∏ ÎåìÍ∏ÄÎ≥¥Îã§ 50px Îì§Ïó¨Ïì∞Í∏∞ */
  border-top: 1px solid #c8c8c8;
  padding-left: 10px; /* ÎÇ¥Ïö©Í≥º Í≤ΩÍ≥ÑÏÑ† ÏÇ¨Ïù¥ Ïó¨Î∞± */
}
.createReply-container{
  display: flex; 
  gap: 10px; 
  margin-left: 50px;
  border-top: 2px solid #c8c8c8;
  padding-top: 20px;
  padding-bottom: 20px;
}
.like-wrapper {
  display: flex;
  align-items: center;
}

/* label ÏûêÎ¶¨ Í≥µÎ∞±ÏùÑ Ïú†ÏßÄ */
.like-wrapper::before {
  content: "";
  display: inline-block;
  width: 50px; /* label ÏòÅÏó≠Ïùò Í∏∞Î≥∏ ÌÅ¨Í∏∞ÏôÄ ÎèôÏùºÌïòÍ≤å ÏÑ§Ï†ï */
}
.comment-user-info {
  display: flex;
  gap: 10px;
  align-items: center;
}
.comment-item-user .el-dropdown {
  margin-left: auto;
}
</style>
