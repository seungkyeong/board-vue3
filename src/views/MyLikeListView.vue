<template>
  <!--Profile Ïª¥Ìè¨ÎÑåÌä∏-->
  <UserProfile />

  <!-- Ï†ÑÏ≤¥ Ïª¥Ìè¨ÎÑåÌä∏ Container-->
  <div class="container">
    <!-- Î≤ÑÌäº Ïª¥Ìè¨ÎÑåÌä∏ Container-->
    <div class="button-container">
      <!-- Í∏ÄÏì∞Í∏∞ Î≤ÑÌäº-->
      <el-button @click="deleteSelected">üóëÔ∏è ÏÇ≠Ï†ú </el-button>
      <el-button type="primary" @click="goWritePage">Í∏ÄÏì∞Í∏∞ </el-button>
    </div>
    <!-- Í≤åÏãúÌåê Î¶¨Ïä§Ìä∏ ÌÖåÏù¥Î∏î-->
    <div class="table-container">
      <el-table
        :data="boardList"
        @selection-change="selectionChange"
        border
        style="width: 100%"
        @row-click="goToDetailPage"
      >
        <el-table-column type="selection" width="40"></el-table-column>
        <el-table-column
          label="sysNo"
          prop="sysNo"
          width="0"
          v-if="hiddenFlag"
        ></el-table-column>
        <el-table-column label="Ï†úÎ™©" show-overflow-tooltip>
          <template #header>
            <div class="header-container">
              Ï†úÎ™©
              <el-icon @click="toggleSearch('title')" class="search-icon">
                <Search />
              </el-icon>
            </div>
            <el-input
              v-if="visibleSearch.title"
              v-model="searchFilters.title"
              @keydown.enter="getSearchBoardList"
            />
          </template>
          <template #default="scope">
            {{ scope.row.title }}
          </template>
        </el-table-column>
        <el-table-column label="ÎÇ¥Ïö©" show-overflow-tooltip>
          <template #header>
            <div class="header-container">
              ÎÇ¥Ïö©
              <el-icon @click="toggleSearch('content')" class="search-icon">
                <Search />
              </el-icon>
            </div>
            <el-input
              v-if="visibleSearch.content"
              v-model="searchFilters.content"
              @keydown.enter="getSearchBoardList"
            />
          </template>
          <template #default="scope">
            {{ scope.row.content }}
          </template>
        </el-table-column>
        <el-table-column
          label="userSysNo"
          prop="userSysNo"
          width="0"
          v-if="hiddenFlag"
        ></el-table-column>
        <el-table-column label="ÏûëÏÑ±Ïûê" show-overflow-tooltip>
          <template #header>
            <div class="header-container">
              ÏûëÏÑ±Ïûê
              <el-icon @click="toggleSearch('userId')" class="search-icon">
                <Search />
              </el-icon>
            </div>
            <el-input
              v-if="visibleSearch.userId"
              v-model="searchFilters.userId"
              @keydown.enter="getSearchBoardList"
            />
          </template>
          <template #default="scope">
            {{ scope.row.userId }}
          </template>
        </el-table-column>
        <el-table-column
          label="imgPath"
          prop="imgPath"
          width="0"
          v-if="hiddenFlag"
        ></el-table-column>
        <el-table-column label="ÏûëÏÑ±Ïùº" show-overflow-tooltip>
          <template #header>
            <div class="header-container">
              ÏûëÏÑ±Ïùº
              <el-icon @click="toggleSearch('createDate')" class="search-icon">
                <Search />
              </el-icon>
            </div>
            <div class="datepicker-container">
              <el-date-picker
                v-model="searchFilters.createDate"
                v-if="visibleSearch.createDate"
                @keydown.enter="getSearchBoardList"
                type="date"
              />
            </div>
          </template>
          <template #default="scope">
            {{ scope.row.formattedCreateDate }}
          </template>
        </el-table-column>
        <el-table-column label="ÏàòÏ†ïÏùº" show-overflow-tooltip>
          <template #header>
            <div class="header-container">
              ÏàòÏ†ïÏùº
              <el-icon @click="toggleSearch('modifyDate')" class="search-icon">
                <Search />
              </el-icon>
            </div>
            <div class="datepicker-container">
              <el-date-picker
                v-model="searchFilters.modifyDate"
                v-if="visibleSearch.modifyDate"
                @keydown.enter="getSearchBoardList"
                type="date"
              />
            </div>
          </template>
          <template #default="scope">
            {{ scope.row.formattedModifyDate }}
          </template>
        </el-table-column>
        <el-table-column label="Ï°∞ÌöåÏàò" show-overflow-tooltip>
          <template #default="scope">
            {{ scope.row.view }}
          </template>
        </el-table-column>
      </el-table>
    </div>

    <!-- ÌéòÏù¥Ïßï Ïª¥Ìè¨ÎÑåÌä∏ -->
    <div class="paging-container">
      <el-pagination
        :total="allBoardListCount"
        :current-page="currentPage"
        :page-size="pageSize"
        @current-change="chagePaging"
        layout="prev, pager, next, jumper"
      />
    </div>
  </div>
</template>

<script>
import UserProfile from '../components/Profile'
import { useRouter } from 'vue-router'
import { reactive, ref, onMounted } from 'vue' //ref:DOM ÏöîÏÜåÏùò ÏÉÅÌÉú Î≥ÄÌôîÎ•º Í∞êÏßÄÌï† Ïàò ÏûàÎäî Í∞ùÏ≤¥ //computed
import { Search } from '@element-plus/icons-vue'
import boardAPI from '../api/BoardAPI'
import { useAuthStore } from '../store/auth'
import { ElMessageBox } from 'element-plus'
// import Cookies from 'js-cookie'

export default {
  components: {
    UserProfile,
    Search,
  },
  setup() {
    const router = useRouter()
    const authStore = useAuthStore()
    const userId = authStore.getUserId
    const userSysNo = authStore.getSysNo

    const hiddenFlag = ref(false) //falseÎ°ú ÏÑ§Ï†ï
    const allBoardListCount = ref(1) //Ï†ÑÏ≤¥ Í≤åÏãúÌåê Î™©Î°ù Í∞úÏàò
    const boardList = ref([]) //ÌòÑÏû¨ ÌëúÏãúÌï† Í≤åÏãúÌåê Îç∞Ïù¥ÌÑ∞
    const currentPage = ref(1)
    const selectedRows = ref([]) // ÏÑ†ÌÉùÎêú ÌñâÎì§Ïù¥ Îì§Ïñ¥Í∞à Î∞∞Ïó¥
    const pageSize = 10

    //inputÎûÄ ÌÖçÏä§Ìä∏
    const searchFilters = reactive({
      title: '',
      content: '',
      userId: '',
      createDate: '',
      modifyDate: '',
    })

    //Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò ÎàåÎ†ÄÏùÑ ÎñÑ Ï°∞Í±¥Î∂Ä Î†åÎçîÎßÅ Ìï† Ïàò ÏûàÎèÑÎ°ù ÌïòÎäî Îç∞Ïù¥ÌÑ∞
    const visibleSearch = reactive({
      title: false,
      content: false,
      userId: false,
      createDate: false,
      modifyDate: false,
    })

    //Î°úÎìúÏãú Í≤åÏãúÌåê Î™©Î°ù Ï°∞Ìöå
    onMounted(() => {
      getBoardList({
        type: 'myLikeList',
        searchList: Object.fromEntries(new Map()), //Îπà Îßµ
        pageSize: pageSize,
        pageIndex: currentPage.value * pageSize - pageSize,
        userId: userId,
        userSysNo: userSysNo,
      })
    })

    //Í≤åÏãúÌåê Î™©Î°ù Î°úÎìú
    const getBoardList = async (requestData) => {
      const response = await boardAPI.getBoardList(requestData)
      if (response.success) {
        allBoardListCount.value = response.data[0] //Í≤åÏãúÌåê Î™©Î°ù Ï†ÑÏ≤¥ Í∞úÏàò
        boardList.value = response.data[1] //Í≤åÏãúÌåê Î™©Î°ù Ï°∞Ìöå
      }
    }

    //Í≤ÄÏÉâÎûÄ EnterÏãúÏóê Ï°∞Í±¥ÏúºÎ°ú Í≤ÄÏÉâ
    const getSearchBoardList = () => {
      const filter = Object.entries(searchFilters)
        .filter(([, value]) => value !== '') // Îπà Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í∞íÎßå ÎÇ®Í∏∞Í∏∞
        .reduce((acc, [key, value]) => {
          acc[key] = value // Îã§Ïãú Í∞ùÏ≤¥ ÌòïÌÉúÎ°ú Î≥ÄÌôò
          return acc
        }, {})
      getBoardList({
        type: 'myLikeList',
        searchList: filter,
        pageSize: pageSize,
        pageIndex: currentPage.value * pageSize - pageSize,
        userId: userId,
        userSysNo: userSysNo,
      })

      //ÌÜ†Í∏Ä false
      Object.keys(visibleSearch).forEach((key) => {
        visibleSearch[key] = false
      })
    }

    // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω Ïãú currentPage ÏóÖÎç∞Ïù¥Ìä∏
    const chagePaging = (page) => {
      currentPage.value = page
      getSearchBoardList()
    }

    //Í≤ÄÏÉâ ÏïÑÏù¥ÏΩò ÎàåÎ†ÄÏùÑ Îïå inputbox Î†åÎçîÎßÅ ÌïòÎäî Ìï®Ïàò(true,false ÌÜ†Í∏Ä)
    const toggleSearch = (field) => {
      visibleSearch[field] = !visibleSearch[field]
    }

    //Í∏ÄÏì∞Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú Í∏ÄÏì∞Í∏∞ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    const goWritePage = () => {
      router.push({ path: '/board/post' })
    }

    //Ìñâ ÌÅ¥Î¶≠Ïãú ÏÉÅÏÑ∏ ÌéòÏóêÏßÄÎ°ú Ïù¥Îèô
    const goToDetailPage = async (row) => {
      await boardAPI.updateCount({
        type: 'view',
        action: 'Increase',
        sysNo: row.sysNo,
        userId: userId,
        userSysNo: userSysNo,
      })
      router.push({ path: `/board/detail/${row.sysNo}` })
    }

    //Ï≤¥ÌÅ¨ Î∞ïÏä§ ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú, Ìï¥Îãπ Í≤åÏãúÎ¨º ÏÇ≠Ï†ú
    const deleteSelected = async () => {
      console.log('selectedRows.value: ', selectedRows.value)
      if (selectedRows.value.length > 0) {
        // Ïòà: ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞, Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏÇ≠Ï†úÌïòÍ∏∞ Îì±
        const response = await boardAPI.deleteLikeList({
          type: 'like',
          action: 'Decrease',
          userId: userId,
          userSysNo: userSysNo,
          deleteList: selectedRows.value,
        })
        if (response.success) {
          ElMessageBox.alert('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', '', {
            confirmButtonText: 'ÌôïÏù∏',
            type: 'success',
          })
            .then(() => {
              getBoardList({
                type: 'myLikeList',
                searchList: Object.fromEntries(new Map()), //Îπà Îßµ
                pageSize: pageSize,
                pageIndex: currentPage.value * pageSize - pageSize,
                userId: userId,
                userSysNo: userSysNo,
              })
            })
            .catch(() => {})
        } else {
          ElMessageBox.alert(response.message, '', {
            confirmButtonText: 'ÌôïÏù∏',
            type: 'error',
          }).catch(() => {})
        }
      } else {
        ElMessageBox.alert('ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.', '', {
          confirmButtonText: 'ÌôïÏù∏',
          type: 'error',
        }).catch(() => {})
      }
    }

    //Ï≤¥ÌÅ¨ Î∞ïÏä§ ÏÑ†ÌÉùÏãú selectedRowsÏóê sysNo ÏÑ∏ÌåÖ
    const selectionChange = (val) => {
      selectedRows.value = val.map((row) => row.sysNo)
    }

    return {
      boardList,
      searchFilters,
      visibleSearch,
      currentPage,
      hiddenFlag,
      pageSize,
      allBoardListCount,
      toggleSearch,
      goWritePage,
      goToDetailPage,
      getBoardList,
      getSearchBoardList,
      chagePaging,
      deleteSelected,
      selectedRows,
      selectionChange,
    }
  },
}
</script>

<style scoped>
.button-container {
  display: flex;
  justify-content: flex-end; /* Î≤ÑÌäºÏùÑ Ïò§Î•∏Ï™ΩÏúºÎ°ú Ï†ïÎ†¨ */
  margin: 10px 0; /* ÌïÑÏöîÏóê Îî∞Îùº Ïó¨Î∞± Ï∂îÍ∞Ä */
}
.container {
  padding: 0px 200px 30px 200px;
}
.header-container {
  display: flex;
  justify-content: space-between;
}
.table-container {
  height: 440px;
  border : 1px solid #f7f3f3;
}
.el-table__inner-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
}
.paging-container {
  display: flex;
  justify-content: center;
  padding: 30px;
}
.search-icon {
  cursor: pointer;
  margin-left: 8px;
  font-size: 16px;
  color: #409eff;
}
.datepicker-container {
  width: 100%; /* Î∂ÄÎ™® ÏöîÏÜåÏóê Îî± ÎßûÍ≤å */
  margin-top: 5px;
  display: flex;
}
</style>
